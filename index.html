<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>All-In-One 2D RPG</title>
  <style>
    body { margin:0; overflow:hidden; background:#000; }
    #gameContainer { position:relative; width:512px; height:384px; margin:0 auto; overflow:hidden; }
    canvas { display:block; }
    /* overlays */
    #fadeOverlay { position:absolute; top:0; left:0; width:100%; height:100%; background:#000; opacity:0; pointer-events:none; transition:opacity 500ms ease; }
    #battleUI, #dialogueBox, #questLog { position:absolute; top:0; left:0; width:100%; height:100%; display:none; font-family:Arial,sans-serif; color:#fff; }
    #battleUI { display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.8); pointer-events:none; }
    #battleMenu { position:absolute; bottom:20px; left:50%; transform:translateX(-50%); }
    #dialogueBox { bottom:20px; left:50%; transform:translateX(-50%); width:70%; background:rgba(0,0,0,0.8); padding:12px; border-radius:8px; pointer-events:auto; }
    #questLog { top:20px; right:20px; width:200px; max-height:70%; background:rgba(0,0,0,0.8); padding:12px; border-radius:8px; overflow-y:auto; pointer-events:auto; }
    #debugInfo { position:absolute; top:0; left:0; color:lime; padding:4px; font-family:monospace; }
  </style>
</head>
<body>
  <div id="gameContainer">
    <canvas id="gameCanvas" width="512" height="384"></canvas>
    <div id="fadeOverlay"></div>
    <!-- Battle UI -->
    <div id="battleUI">
      <canvas id="battleCanvas" width="512" height="384" style="background:#222;"></canvas>
      <div id="battleMenu">
        <ul id="menuOptions" style="list-style:none;padding:0;margin:0;">
          <li>▶ Attack</li><li>   Defend</li><li>   Item</li>
        </ul>
      </div>
    </div>
    <!-- Dialogue Box -->
    <div id="dialogueBox">
      <p id="dialogueText" style="margin:0 0 8px;"></p>
      <ul id="choiceList" style="list-style:none;padding:0;margin:0;"></ul>
    </div>
    <!-- Quest Log -->
    <div id="questLog">
      <h3 style="margin:0 0 8px;">Quest Log</h3>
      <ul id="questList" style="list-style:none;padding:0;margin:0;"></ul>
    </div>
  </div>

  <script>
  (function(){
    // ───────── CONFIG ─────────
    const TRANSITION_TYPE     = 'slide'; // 'fade' or 'slide'
    const TRANSITION_DURATION = 500;     // ms
    const TILE_SIZE           = 32;
    const FPS                 = 60;
    const STEP_MS             = 1000 / FPS;

    // ───────── INLINE MAPS ─────────
    function generateMap(w,h,doors){
      const tiles = [];
      for(let y=0; y<h; y++){
        const row = [];
        for(let x=0; x<w; x++){
          let id = (x===0||y===0||x===w-1||y===h-1) ? 2 : 1; // wall=2, floor=1
          doors.forEach(([dx,dy])=>{ if(x===dx&&y===dy) id=3 }); // door=3
          row.push(id);
        }
        tiles.push(row);
      }
      return { width:w, height:h, tiles };
    }
    const MAPS = {
      townSquare:      generateMap(16,12,[[3,2],[10,2]]),
      dungeonEntrance: generateMap(16,12,[[1,1]]),
      shop:            generateMap(16,12,[[0,5]])
    };
    const DOOR_TRIGGERS = {
      townSquare:{ '3,2':{to:'dungeonEntrance',spawn:{x:1.5*TILE_SIZE,y:1.5*TILE_SIZE}},
                   '10,2':{to:'shop',spawn:{x:2.5*TILE_SIZE,y:3.5*TILE_SIZE}} },
      dungeonEntrance:{ '1,1':{to:'townSquare',spawn:{x:4.5*TILE_SIZE,y:2.5*TILE_SIZE}} },
      shop:{ '0,5':{to:'townSquare',spawn:{x:10.5*TILE_SIZE,y:2.5*TILE_SIZE}} }
    };

    // ───────── DOM REFS ─────────
    const canvas    = document.getElementById('gameCanvas'),
          ctx       = canvas.getContext('2d'),
          fadeDiv   = document.getElementById('fadeOverlay'),
          container = document.getElementById('gameContainer');

    fadeDiv.style.transition      = `opacity ${TRANSITION_DURATION}ms ease`;
    container.style.transition    = `transform ${TRANSITION_DURATION}ms ease`;

    // ───────── MAP LOADER ─────────
    class MapLoader {
      constructor(size,ctx,blocked,doors){ this.ts=size; this.ctx=ctx; this.blocked=blocked; this.doors=doors; }
      drawMap(m,room){
        this.map=m; this.room=room;
        m.tiles.forEach((row,y)=>{
          row.forEach((id,x)=>{
            let c = id===1? '#8FBC8F' : id===2? '#555' : id===3? '#8B4513' : '#000';
            this.ctx.fillStyle
