<script>
(() => {
  //──── CONFIG ────
  const CANVAS_ID = 'gameCanvas';
  const WIDTH  = 960, HEIGHT = 640;
  const TILE   = 32, MAP_C = 60, MAP_R = 40;
  const WORLD_W = MAP_C * TILE, WORLD_H = MAP_R * TILE;

  //──── STATE ────
  let canvas, ctx;
  let offscreen, octx;
  let skyCanvas, skyCtx;
  let lastTs = 0, cityOffset = 0;
  let frameCount = 0, fpsTime = 0;

  //──── BOOT ────
  window.addEventListener('load', init);

  function init() {
    canvas = document.getElementById(CANVAS_ID);
    // **Always use 2D** so ctx is never undefined :contentReference[oaicite:0]{index=0}
    ctx = canvas.getContext('2d');
    canvas.width = WIDTH; canvas.height = HEIGHT;
    canvas.style.background = '#000';

    // Offscreen buffer for world+grid
    offscreen = document.createElement('canvas');
    offscreen.width = WIDTH; offscreen.height = HEIGHT;
    octx = offscreen.getContext('2d');

    // Pre-create skyline layer
    skyCanvas = document.createElement('canvas');
    skyCanvas.width = WIDTH; skyCanvas.height = HEIGHT;
    skyCtx = skyCanvas.getContext('2d');
    createSkyline();

    requestAnimationFrame(loop);
  }

  function createSkyline() {
    // draw simple blocks for skyline
    skyCtx.fillStyle = 'rgba(50,50,70,0.2)';
    for (let i = 0; i < 25; i++) {
      const w = 60 + Math.random()*80;
      const h = 100 + Math.random()*150;
      skyCtx.fillRect(i*(WIDTH/25), HEIGHT - h - 50, w, h);
    }
  }

  function drawParallax(dt) {
    cityOffset = (cityOffset + dt*0.02) % WIDTH;
    // clear and draw two slices for wrap
    ctx.clearRect(0, 0, WIDTH, HEIGHT);
    ctx.drawImage(skyCanvas, -cityOffset, 0);
    ctx.drawImage(skyCanvas, WIDTH - cityOffset, 0);
  }

  function drawNeonGrid() {
    octx.save();
    octx.strokeStyle = 'rgba(255,0,255,0.15)';
    octx.lineWidth = 1;
    // vertical lines
    for (let x = 0; x <= WORLD_W; x += TILE*5) {
      const sx = (x + cityOffset*0.5) % WIDTH;
      octx.beginPath(); octx.moveTo(sx, 0); octx.lineTo(sx, HEIGHT); octx.stroke();
    }
    // horizontal lines
    for (let y = 0; y <= WORLD_H; y += TILE*5) {
      const sy = (y + cityOffset*0.3) % HEIGHT;
      octx.beginPath(); octx.moveTo(0, sy); octx.lineTo(WIDTH, sy); octx.stroke();
    }
    octx.restore();
  }

  function loop(ts) {
    const dt = ts - lastTs;
    lastTs = ts;

    // measure FPS
    frameCount++; fpsTime += dt;
    if (fpsTime >= 1000) {
      console.log('FPS:', frameCount);
      frameCount = 0; fpsTime = 0;
    }

    // 1) Parallax skyline
    drawParallax(dt);

    // 2) Prepare offscreen
    octx.setTransform(1,0,0,1,0,0);
    octx.clearRect(0, 0, WIDTH, HEIGHT);

    // 3) Base floor fill (placeholder for tiles) 
    octx.fillStyle = '#111';
    octx.fillRect(0, 0, WIDTH, HEIGHT);

    // 4) Neon grid overlay
    drawNeonGrid();

    // 5) Blit offscreen onto main 2D canvas
    ctx.drawImage(offscreen, 0, 0);

    requestAnimationFrame(loop);
  }

})();
</script>
